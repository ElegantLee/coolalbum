"use strict";!function(){var g="undefined"!=typeof window&&void 0!==window.document?window.document:{},e="undefined"!=typeof module&&module.exports,y={initRegion:function(o){layui.use("form",function(){var i=layui.form;i.render(),o=o||[0,0,0],Util.ajax({url:"https://static.tantupix.com/region.json"}).then(function(e){var n=e,a="";n.forEach(function(e){var t="";o[0]==e.text&&(t="selected",y.loadCityData(i,n,e.text,o)),a+='<option value="'+e.text+'" '+t+">"+e.text+"</option>"}),$("form").find("select[name=province]").append(a),i.render(),i.on("select(province)",function(e){$("form").find("select[name=district]").html('<option value="">选择县/区</option>'),$("form").find("select[name=city]").html('<option value="">选择市</option>'),y.loadCityData(i,n,e.value.split(",")[0],o)})})})},loadCityData:function(n,a,i,o){var r="";a.forEach(function(e){i==e.text&&(e.children.forEach(function(e){var t="";o[1]==e.text&&(t="selected",y.loadDistrictData(n,a,i,e.text,o)),r+='<option value="'+e.text+'" '+t+">"+e.text+"</option>"}),$("form").find("select[name=city]").append(r),n.render(),n.on("select(city)",function(e){$("form").find("select[name=district]").html('<option value="">选择县/区</option>'),y.loadDistrictData(n,a,i,e.value.split(",")[0],o)}))})},loadDistrictData:function(t,e,n,a,i){var o="";e.forEach(function(e){n==e.text&&(e.children.forEach(function(e){a==e.text&&e.children.forEach(function(e){var t="";i[2]==e.text&&(t="selected"),o+='<option value="'+e.text+'" '+t+">"+e.text+"</option>"})}),$("form").find("select[name=district]").append(o),t.render())})},getPersonalInfo:function(){var i=this;Util.ajax({url:"/share/personal/Info"}).then(function(e){var t=e.address,n=[];if(t){var a=t.split(",");e.province=a[0],e.city=a[1],e.district=a[2],n=a}g.getElementById("userInfo").innerHTML=template("userInfoTpl",e),layui.use("laydate",function(){layui.laydate.render({elem:"#birth_laydate"})}),layui.use("form",function(){layui.form.render(),y.initRegion(n)}),i.changePersonalInfo(),$(".lazy-img").lazyload(),y.avatarUpToken()})},changePersonalInfo:function(){layui.use("form",function(){layui.form.on("submit(changePersonalInfoForm)",function(e){e.field.gender||(e.field.gender=1),e.field.birth||(e.field.birth="1970-01-01"),e.field.is_secrecy_qq||(e.field.is_secrecy_qq=0),e.field.is_secrecy_weixin||(e.field.is_secrecy_weixin=0),e.field.is_secrecy_mobile||(e.field.is_secrecy_mobile=0),e.field.is_secrecy_email||(e.field.is_secrecy_email=0);var t=[e.field.province,e.field.city,e.field.district];e.field.address=t.toString();var n={url:"/share/personal/ChangeInfo",type:"post",data:e.field};return Util.ajax(n).then(function(e){layer.msg("更新成功"),y.getPersonalInfo()}),!1})})},avatarUpToken:function(){Util.ajax({url:"/share/personal/AvatarUpToken"}).then(function(e){$("#update_avatar").off("click"),$("#update_avatar").on("click",function(){y.uploadAvatar(e)})})},fileSelectHandler:function(m){var e=g.getElementById("imageFile").files[0];if(/^(image\/jpeg|image\/jpg|image\/png)$/i.test(e.type))if(31457280<e.size)layer.msg("图片大小不能大于30M");else{var v=g.getElementById("jcropTarget"),t=new FileReader;t.readAsDataURL(e),t.onload=function(e){v.src=e.target.result,v.onload=function(){$(".jcrop-holder").remove();var e=$(".canvas-jcrop-preview-thumb"),c=e.width(),s=e.height(),t=$.Jcrop("#jcropTarget",{onChange:l,onSelect:l,onDblClick:function(){y.setData(m)},aspectRatio:1,boxWidth:400,boxHeight:400,minSize:[130,130]}),n=t.getBounds(),a=n[0],i=n[1],o=t.getWidgetSize(),d=o[0],f=o[1],r=t.getScaleFactor(),u=r[0],p=r[1];function l(e){if(0<parseInt(e.w)){var t=g.getElementById("myCanvas").getContext("2d"),n=g.getElementById("jcropTarget"),a=v.width,i=v.height,o=a/d,r=i/f,l=0;l=r<=o?o:r,t.drawImage(n,e.x/u*l,e.y/p*l,e.w/u*l,e.h/p*l,0,0,c,s)}}i<a?t.setSelect([(a-f*p)/2,0,a,i]):t.setSelect([0,(i-d*p)/2,a,i]),g.getElementById("cutImage").addEventListener("click",function(){console.log(1),y.setData(m)})}}}else layer.msg("请选择jpg和png格式的图片")},setData:function(e){layer.msg("正在处理，请稍候！",{time:1e4});var t=g.getElementById("myCanvas").toDataURL(),n=t.split(",")[0].match(/:(.*?);/)[1].length,a=parseInt(n+13);t=t.substring(a);var i=e.token,o=e.keyPrefix,r=e.upload_domain;y.putb64(i,o,t,r)},putb64:function(e,t,n,a){var i=Util.fileSize(n),o=Util.URLSafeBase64Encode(t),r=n,l="//"+a+"/putb64/"+i+"/key/"+o,c=new XMLHttpRequest;c.onreadystatechange=function(){if(4==c.readyState){var e=c.responseText,t={url:JSON.parse(e).hReturnUrl,type:"post",data:{upload_ret:e}};Util.ajax(t).then(function(e){$(".js_user_avatar").attr("src","data:image/png;base64,"+n),layer.closeAll(),layer.msg("更新成功"),y.avatarUpToken()})}},c.open("POST",l,!0),c.setRequestHeader("Content-Type","application/octet-stream"),c.setRequestHeader("Authorization","UpToken "+e),c.send(r)},uploadAvatar:function(e){layer.open({type:1,title:"更新用户头像",shadeClose:!1,shade:[.8],area:["480px"],maxmin:!1,scrollbar:!1,content:'<div class="canvas-jcrop">\n        <div class="canvas-jcrop-preview">\n          <div class="canvas-jcrop-preview-original">\n            <img src="" id="jcropTarget">\n          </div>\n          <div class="canvas-jcrop-preview-thumb layui-hide">\n            <canvas class="canvas" id="myCanvas" width="200" height="200"></canvas>\n          </div>\n        </div>\n        <div class="upload-btn t-bg-rose">\n          <span class="upload-btn-tit">选择图片</span>\n          <input class="file-btn" id="imageFile" type="file">\n        </div>\n        <div class="upload-btn t-bg-rose" id="cutImage">保存更改</div>\n      </div>'});layer.index;$("#imageFile").change(function(){y.fileSelectHandler(e)})}};y.getPersonalInfo(),e?module.exports=y:window.SettingInfo=y}();